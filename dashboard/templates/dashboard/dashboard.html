{% extends 'base.html' %}
{% block title %}Dashboard - T·ªïng quan{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-1">üìä Dashboard T·ªïng Quan</h2>
                <p class="text-muted mb-0">Th·ªëng k√™ to√†n h·ªá th·ªëng - H·ªçc k·ª≥ {{ current_semester }} - {{ current_year }}</p>
            </div>
            <div>
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill px-3 py-2 fs-6">
                    <i class="fas fa-sync-alt me-2"></i>C·∫≠p nh·∫≠t: {% now "H:i" %}
                </span>
            </div>
        </div>
        
        <!-- Semester Filter -->
        <div class="card shadow-sm border-0 rounded-4 mb-4">
            <div class="card-body p-4">
                <h5 class="card-title mb-4">
                    <i class="fas fa-filter me-2 text-primary"></i>B·ªô l·ªçc th·ªëng k√™
                </h5>
                <form method="get">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">H·ªçc k·ª≥:</label>
                            <select name="hoc_ky" class="form-select form-select-lg border-primary border-2">
                                {% for value, label in HOC_KY_CHOICES %}
                                    <option value="{{ value }}" {% if current_semester == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">NƒÉm h·ªçc:</label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text bg-primary text-white border-primary">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                <input type="text" name="nam_hoc" class="form-control border-primary border-2" 
                                       value="{{ current_year }}" placeholder="VD: 2023-2024">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100 py-3">
                                <i class="fas fa-chart-bar me-2"></i>üîç Xem th·ªëng k√™
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Overview Statistics - Version v·ªõi ch·ªØ ƒëen -->
<div class="row mb-4 g-3">
    <div class="col-md-3">
        <div class="card border-0 rounded-4 shadow-lg h-100 hover-lift" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-2 text-primary">üë• Sinh vi√™n</h5>
                        <h2 class="display-4 fw-bold text-dark">{{ total_students }}</h2>
                    </div>
                    <div class="avatar-circle bg-primary bg-opacity-10">
                        <i class="fas fa-user-graduate fa-2x text-primary"></i>
                    </div>
                </div>
                <p class="mb-0 text-muted">T·ªïng s·ªë sinh vi√™n trong h·ªá th·ªëng</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 rounded-4 shadow-lg h-100 hover-lift" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-2 text-success">üè´ L·ªõp h·ªçc</h5>
                        <h2 class="display-4 fw-bold text-dark">{{ total_classes }}</h2>
                    </div>
                    <div class="avatar-circle bg-success bg-opacity-10">
                        <i class="fas fa-school fa-2x text-success"></i>
                    </div>
                </div>
                <p class="mb-0 text-muted">L·ªõp h·ªçc ƒëang ho·∫°t ƒë·ªông</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 rounded-4 shadow-lg h-100 hover-lift" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-2 text-info">üìö M√¥n h·ªçc</h5>
                        <h2 class="display-4 fw-bold text-dark">{{ total_subjects }}</h2>
                    </div>
                    <div class="avatar-circle bg-info bg-opacity-10">
                        <i class="fas fa-book-open fa-2x text-info"></i>
                    </div>
                </div>
                <p class="mb-0 text-muted">M√¥n h·ªçc ƒë∆∞·ª£c gi·∫£ng d·∫°y</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 rounded-4 shadow-lg h-100 hover-lift" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
            <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-2 text-warning">üë®‚Äçüè´ Gi√°o vi√™n</h5>
                        <h2 class="display-4 fw-bold text-dark">{{ total_teachers }}</h2>
                    </div>
                    <div class="avatar-circle bg-warning bg-opacity-10">
                        <i class="fas fa-chalkboard-teacher fa-2x text-warning"></i>
                    </div>
                </div>
                <p class="mb-0 text-muted">Gi√°o vi√™n ƒëang gi·∫£ng d·∫°y</p>
            </div>
        </div>
    </div>
</div>

<!-- Current Semester Stats -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 rounded-4 shadow-sm">
            <div class="card-header bg-dark bg-gradient text-white py-3 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-chart-pie me-2"></i>üìà Th·ªëng k√™ h·ªçc k·ª≥ {{ current_semester }} - {{ current_year }}
                    </h5>
                    <span class="badge bg-white text-dark rounded-pill px-3 py-1 fs-6">
                        T·ª∑ l·ªá ƒë·∫°t: {% widthratio passed_count total_students 100 %}%
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row text-center g-4">
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded-4">
                            <div class="mb-3">
                                <i class="fas fa-calculator fa-3x text-primary opacity-75"></i>
                            </div>
                            <h3 class="fw-bold text-primary">{{ average_grade }}</h3>
                            <p class="text-muted mb-0">ƒêi·ªÉm trung b√¨nh chung</p>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar bg-primary" 
                                     style="width: {% widthratio average_grade 10 100 %}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded-4">
                            <div class="mb-3">
                                <i class="fas fa-check-circle fa-3x text-success opacity-75"></i>
                            </div>
                            <h3 class="fw-bold text-success">{{ passed_count }}</h3>
                            <p class="text-muted mb-0">Sinh vi√™n ƒë·∫°t (‚â• 5.0)</p>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar bg-success" 
                                     style="width: {% widthratio passed_count total_students 100 %}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-4 bg-light rounded-4">
                            <div class="mb-3">
                                <i class="fas fa-times-circle fa-3x text-danger opacity-75"></i>
                            </div>
                            <h3 class="fw-bold text-danger">{{ failed_count }}</h3>
                            <p class="text-muted mb-0">Sinh vi√™n ch∆∞a ƒë·∫°t (< 5.0)</p>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar bg-danger" 
                                     style="width: {% widthratio failed_count total_students 100 %}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts and Top Students -->
<div class="row mb-4 g-3">
    <div class="col-lg-6">
        <div class="card border-0 rounded-4 shadow-sm h-100">
            <div class="card-header bg-info bg-gradient text-white py-3 rounded-top-4">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-chart-bar me-2"></i>üìä Ph√¢n b·ªë ƒëi·ªÉm
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="chart-container" style="position: relative; height: 300px;">
                    <canvas id="gradeDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card border-0 rounded-4 shadow-sm h-100">
            <div class="card-header bg-success bg-gradient text-white py-3 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-trophy me-2"></i>üèÜ Top 5 sinh vi√™n
                    </h5>
                    <span class="badge bg-white text-success rounded-pill px-3 py-1">
                        GPA cao nh·∫•t
                    </span>
                </div>
            </div>
            <div class="card-body p-4">
                {% if top_students %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 50px;">#</th>
                                    <th>Sinh vi√™n</th>
                                    <th class="text-center">GPA</th>
                                    <th class="text-center">X·∫øp h·∫°ng</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gpa_record in top_students %}
                                    <tr class="transition-all">
                                        <td class="text-center">
                                            {% if forloop.counter == 1 %}
                                                <span class="badge bg-warning text-dark rounded-circle p-2">ü•á</span>
                                            {% elif forloop.counter == 2 %}
                                                <span class="badge bg-secondary text-white rounded-circle p-2">ü•à</span>
                                            {% elif forloop.counter == 3 %}
                                                <span class="badge bg-danger text-white rounded-circle p-2">ü•â</span>
                                            {% else %}
                                                <span class="fw-bold text-muted">#{{ forloop.counter }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-3">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">{{ gpa_record.student.ho_ten }}</h6>
                                                    <small class="text-muted">{{ gpa_record.student.ma_sv }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold fs-4 text-success">{{ gpa_record.gpa }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge rounded-pill px-3 py-2 fs-6 
                                                {% if gpa_record.gpa >= 8.5 %}bg-success
                                                {% elif gpa_record.gpa >= 7.0 %}bg-primary
                                                {% elif gpa_record.gpa >= 5.5 %}bg-warning
                                                {% else %}bg-secondary{% endif %}">
                                                {% if gpa_record.gpa >= 8.5 %}Xu·∫•t s·∫Øc
                                                {% elif gpa_record.gpa >= 7.0 %}Gi·ªèi
                                                {% elif gpa_record.gpa >= 5.5 %}Kh√°
                                                {% else %}Trung b√¨nh{% endif %}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-trophy fa-3x text-muted opacity-25 mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu GPA</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Subject Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 rounded-4 shadow-sm">
            <div class="card-header bg-warning bg-gradient text-dark py-3 rounded-top-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-book me-2"></i>üìö Th·ªëng k√™ theo m√¥n h·ªçc
                    </h5>
                    <span class="badge bg-dark text-white rounded-pill px-3 py-1">
                        {{ subjects_stats|length }} m√¥n h·ªçc
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if subjects_stats %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="py-3 ps-4">M√¥n h·ªçc</th>
                                    <th class="text-center py-3">ƒêi·ªÉm TB</th>
                                    <th class="text-center py-3">T·ªïng SV</th>
                                    <th class="text-center py-3">ƒê·∫°t</th>
                                    <th class="text-center py-3">Kh√¥ng ƒë·∫°t</th>
                                    <th class="text-center py-3 pe-4">T·ªâ l·ªá ƒë·∫°t</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in subjects_stats %}
                                    <tr>
                                        <td class="ps-4">
                                            <div class="d-flex align-items-center">
                                                <div class="subject-icon bg-primary bg-opacity-10 text-primary rounded-3 p-2 me-3">
                                                    <i class="fas fa-book fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold">{{ stat.subject.ten_mon }}</h6>
                                                    <small class="text-muted">{{ stat.subject.ma_mon }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="fw-bold fs-5 
                                                {% if stat.avg_score >= 8.5 %}text-success
                                                {% elif stat.avg_score >= 7.0 %}text-primary
                                                {% elif stat.avg_score >= 5.0 %}text-warning
                                                {% else %}text-danger{% endif %}">
                                                {{ stat.avg_score }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary bg-opacity-25 text-secondary rounded-pill px-3 py-1">
                                                {{ stat.total }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success bg-opacity-10 text-success rounded-pill px-3 py-1">
                                                {{ stat.passed }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-danger bg-opacity-10 text-danger rounded-pill px-3 py-1">
                                                {{ stat.failed }}
                                            </span>
                                        </td>
                                        <td class="pe-4">
                                            <div class="d-flex align-items-center">
                                                <div class="progress flex-grow-1 me-3" style="height: 8px;">
                                                    <div class="progress-bar 
                                                        {% if stat.passed_ratio >= 80 %}bg-success
                                                        {% elif stat.passed_ratio >= 60 %}bg-info
                                                        {% elif stat.passed_ratio >= 40 %}bg-warning
                                                        {% else %}bg-danger{% endif %}" 
                                                        style="width: {{ stat.passed_ratio }}%">
                                                    </div>
                                                </div>
                                                <span class="fw-bold">{{ stat.passed_ratio|floatformat:0 }}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-book fa-3x text-muted opacity-25 mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu ƒëi·ªÉm s·ªë</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Class Statistics -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 rounded-4 shadow-sm">
            <div class="card-header bg-primary bg-gradient text-white py-3 rounded-top-4">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-chart-line me-2"></i>üè´ Th·ªëng k√™ GPA theo l·ªõp
                </h5>
            </div>
            <div class="card-body p-4">
                {% if classes_stats %}
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="classGPAChart"></canvas>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-school fa-3x text-muted opacity-25 mb-3"></i>
                        <p class="text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu l·ªõp h·ªçc</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Script cho Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ grade_distribution|default:"{}"|json_script:"grade-dist-data" }}
{{ classes_stats|default:"[]"|json_script:"classes-stats-data" }}
<script>
    // X·ª≠ l√Ω d·ªØ li·ªáu ph√¢n b·ªë ƒëi·ªÉm
    const rawGradeDist = JSON.parse(document.getElementById('grade-dist-data').textContent || '{}');
    const gradeDistData = {
        'A': Number(rawGradeDist["A (8.5-10)"] || 0),
        'B': Number(rawGradeDist["B (7.0-8.4)"] || 0),
        'C': Number(rawGradeDist["C (5.5-6.9)"] || 0),
        'D': Number(rawGradeDist["D (4.0-5.4)"] || 0),
        'F': Number(rawGradeDist["F (0-3.9)"] || 0)
    };

    // Bi·ªÉu ƒë·ªì ph√¢n b·ªë ƒëi·ªÉm
    const gradeDistCtx = document.getElementById('gradeDistributionChart');
    if (gradeDistCtx) {
        new Chart(gradeDistCtx, {
            type: 'bar',
            data: {
                labels: ['A (8.5-10)', 'B (7.0-8.4)', 'C (5.5-6.9)', 'D (4.0-5.4)', 'F (0-3.9)'],
                datasets: [{
                    label: 'S·ªë l∆∞·ª£ng sinh vi√™n',
                    data: [
                        gradeDistData.A,
                        gradeDistData.B,
                        gradeDistData.C,
                        gradeDistData.D,
                        gradeDistData.F
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(0, 123, 255, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(255, 152, 0, 1)',
                        'rgba(220, 53, 69, 1)'
                    ],
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 6
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
    
    // Bi·ªÉu ƒë·ªì GPA theo l·ªõp
    const classesStats = JSON.parse(document.getElementById('classes-stats-data').textContent || '[]');
    const classGPACtx = document.getElementById('classGPAChart');
    if (classGPACtx && classesStats.length > 0) {
        const classLabels = classesStats.map(function(s) { 
            return (s.class && s.class.ma_lop) ? s.class.ma_lop : ''; 
        });
        const classGPAs = classesStats.map(function(s) { 
            return Number(s.avg_gpa || 0); 
        });
        
        new Chart(classGPACtx, {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{
                    label: 'GPA trung b√¨nh',
                    data: classGPAs,
                    backgroundColor: 'rgba(0, 123, 255, 0.8)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1,
                    borderRadius: 6
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `GPA: ${context.parsed.x.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 4.0,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }
</script>

<style>
    .avatar-circle {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }
    
    .subject-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .hover-lift:hover {
        transform: translateY(-5px);
        transition: all 0.3s ease;
    }
    
    .transition-all {
        transition: all 0.2s ease;
    }
    
    .hover-lift {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}