{% extends 'base.html' %}
{% block title %}Dashboard - Tá»•ng quan{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-4">ğŸ“Š Dashboard Tá»•ng Quan</h2>
        
        <!-- Bá»™ lá»c há»c ká»³ -->
        <form method="get" class="card p-3 mb-4">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Há»c ká»³:</label>
                    <select name="hoc_ky" class="form-select">
                        {% for value, label in HOC_KY_CHOICES %}
                            <option value="{{ value }}" {% if current_semester == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">NÄƒm há»c:</label>
                    <input type="text" name="nam_hoc" class="form-control" value="{{ current_year }}">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary d-block w-100">ğŸ” Xem thá»‘ng kÃª</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Thá»‘ng kÃª tá»•ng quan -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">ğŸ‘¥ Sinh viÃªn</h5>
                <h2 class="display-4">{{ total_students }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">ğŸ« Lá»›p há»c</h5>
                <h2 class="display-4">{{ total_classes }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">ğŸ“š MÃ´n há»c</h5>
                <h2 class="display-4">{{ total_subjects }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <h5 class="card-title">ğŸ‘¨â€ğŸ« GiÃ¡o viÃªn</h5>
                <h2 class="display-4">{{ total_teachers }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Thá»‘ng kÃª há»c ká»³ hiá»‡n táº¡i -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">ğŸ“ˆ Thá»‘ng kÃª há»c ká»³ {{ current_semester }} - {{ current_year }}</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h3 class="text-primary">{{ average_grade }}</h3>
                        <p class="text-muted">Äiá»ƒm trung bÃ¬nh chung</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-success">{{ passed_count }}</h3>
                        <p class="text-muted">Sinh viÃªn Ä‘áº¡t (â‰¥ 5.0)</p>
                    </div>
                    <div class="col-md-4">
                        <h3 class="text-danger">{{ failed_count }}</h3>
                        <p class="text-muted">Sinh viÃªn chÆ°a Ä‘áº¡t (< 5.0)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Biá»ƒu Ä‘á»“ phÃ¢n bá»‘ Ä‘iá»ƒm -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š PhÃ¢n bá»‘ Ä‘iá»ƒm</h5>
            </div>
            <div class="card-body">
                <canvas id="gradeDistributionChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top 5 sinh viÃªn -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">ğŸ† Top 5 sinh viÃªn GPA cao nháº¥t</h5>
            </div>
            <div class="card-body">
                {% if top_students %}
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>MÃ£ SV</th>
                                <th>Há» tÃªn</th>
                                <th>GPA</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gpa_record in top_students %}
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ gpa_record.student.ma_sv }}</td>
                                    <td>{{ gpa_record.student.ho_ten }}</td>
                                    <td><strong>{{ gpa_record.gpa }}</strong></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">ChÆ°a cÃ³ dá»¯ liá»‡u GPA.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Thá»‘ng kÃª theo mÃ´n há»c -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">ğŸ“š Thá»‘ng kÃª theo mÃ´n há»c</h5>
            </div>
            <div class="card-body">
                {% if subjects_stats %}
                    <table class="table table-bordered table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>MÃ£ mÃ´n</th>
                                <th>TÃªn mÃ´n há»c</th>
                                <th>Äiá»ƒm TB</th>
                                <th>Äáº¡t</th>
                                <th>KhÃ´ng Ä‘áº¡t</th>
                                <th>Tá»•ng SV</th>
                                <th>Tá»‰ lá»‡ Ä‘áº¡t</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in subjects_stats %}
                                <tr>
                                    <td>{{ stat.subject.ma_mon }}</td>
                                    <td>{{ stat.subject.ten_mon }}</td>
                                    <td><strong>{{ stat.avg_score }}</strong></td>
                                    <td class="text-success">{{ stat.passed }}</td>
                                    <td class="text-danger">{{ stat.failed }}</td>
                                    <td>{{ stat.total }}</td>
                                    <td>
                                        {% widthratio stat.passed stat.total 100 %}%
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted">ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘iá»ƒm sá»‘.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Thá»‘ng kÃª theo lá»›p -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ« Thá»‘ng kÃª theo lá»›p</h5>
            </div>
            <div class="card-body">
                {% if classes_stats %}
                    <canvas id="classGPAChart"></canvas>
                {% else %}
                    <p class="text-muted">ChÆ°a cÃ³ dá»¯ liá»‡u lá»›p há»c.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Script cho Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{ grade_distribution|default:"{}"|json_script:"grade-dist-data" }}
{{ classes_stats|default:"[]"|json_script:"classes-stats-data" }}
<script>
    // Xá»­ lÃ½ dá»¯ liá»‡u phÃ¢n bá»‘ Ä‘iá»ƒm
    const rawGradeDist = JSON.parse(document.getElementById('grade-dist-data').textContent || '{}');
    const gradeDistData = {
        'A': Number(rawGradeDist["A (8.5-10)"] || 0),
        'B': Number(rawGradeDist["B (7.0-8.4)"] || 0),
        'C': Number(rawGradeDist["C (5.5-6.9)"] || 0),
        'D': Number(rawGradeDist["D (4.0-5.4)"] || 0),
        'F': Number(rawGradeDist["F (0-3.9)"] || 0)
    };

    // Biá»ƒu Ä‘á»“ phÃ¢n bá»‘ Ä‘iá»ƒm
    const gradeDistCtx = document.getElementById('gradeDistributionChart');
    if (gradeDistCtx) {
        new Chart(gradeDistCtx, {
            type: 'bar',
            data: {
                labels: ['A (8.5-10)', 'B (7.0-8.4)', 'C (5.5-6.9)', 'D (4.0-5.4)', 'F (0-3.9)'],
                datasets: [{
                    label: 'Sá»‘ lÆ°á»£ng sinh viÃªn',
                    data: [
                        gradeDistData.A,
                        gradeDistData.B,
                        gradeDistData.C,
                        gradeDistData.D,
                        gradeDistData.F
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(0, 123, 255, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(255, 152, 0, 0.7)',
                        'rgba(220, 53, 69, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Biá»ƒu Ä‘á»“ GPA theo lá»›p
    const classesStats = JSON.parse(document.getElementById('classes-stats-data').textContent || '[]');
    const classGPACtx = document.getElementById('classGPAChart');
    if (classGPACtx && classesStats.length > 0) {
        const classLabels = classesStats.map(function(s) { 
            return (s.class && s.class.ma_lop) ? s.class.ma_lop : ''; 
        });
        const classGPAs = classesStats.map(function(s) { 
            return Number(s.avg_gpa || 0); 
        });
        
        new Chart(classGPACtx, {
            type: 'bar',
            data: {
                labels: classLabels,
                datasets: [{
                    label: 'GPA trung bÃ¬nh',
                    data: classGPAs,
                    backgroundColor: 'rgba(0, 123, 255, 0.7)'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true,
                        max: 4.0
                    }
                }
            }
        });
    }
</script>
{% endblock %}